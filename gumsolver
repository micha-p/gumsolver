#! /usr/bin/lua

package.path = package.path .. ";include/?.lua"
require 'display'
require 'table'

require 'expressions'
require 'process'
require 'csv'
require 'table-mode'
require 'constraints_with_values'
require 'dump'
require 'records'
require 'mask'
require 'trace'
require 'units'


VERSION = "0.3.0"
SCRIPT=arg and string.match(arg[0],"[^%w%-]*([%w%-]*)$")
INFILE=nil
TABLE=nil 
PROMPT=nil
MUTE=nil
RELATIVE=nil
DELIMITER="\t"
RECORD=nil
DEBUG=nil
MASK=nil
TRACE=nil
RECORDS={}			-- number : record
DEFINITIONS={}			-- number : string
COLNAMES={}			-- number : string


-- overwrite !!!!
function printprobe (name, value, unit)
   if MASK then printmaskline (name, value, unit) end
   if DEBUG then warn (PRINT16 (name), PRINT16 (unit or ""), value) end
   if TRACE then warn (short(CONNECTORS[name]), PRINT16 (name), PRINT16 (unit or ""), value) end
   if not MUTE then print (PRINT16 (name), PRINT16 (unit or ""), value) end
end
    


help={}
help[ 1]="gumsolver -- resolving equations by propagation of uncertainties"
help[ 2]="usage:    gumsolver [options] [-f file]"
help[ 3]="options:  -f file        use file for input"
help[ 4]="          -t             read input horizontally as tables"
help[ 5]="          -d delimiter   field separator for input"
help[ 6]="          -a             start displaying absolute uncertainties (default)"
help[ 7]="          -r             start displaying relative uncertainties"
help[ 8]="          -D             debug messages (stderr)"
help[ 9]="          -T             trace signals (stderr)"
help[10]="          -R             Restrict output to records"
help[11]="          -I             interactive (readline wrapper suggested)"
help[12]="          -J             interactive (nonscrolling mask)"
help[13]="          -v             display version"
help[14]="          -q             restrict standard output to special commands"
help[15]="          -h             this help"

while arg and arg[1] do
   TRACE    = TRACE    or arg[1]=="-T"
   TABLE    = TABLE    or arg[1]=="-t"
   PROMPT   = PROMPT   or arg[1]=="-I" and "> "
   DEBUG    = DEBUG    or arg[1]=="-D"
   MASK     = MASK     or arg[1]=="-J"
   RECORD   = RECORD   or arg[1]=="-R"
   MUTE     = MUTE     or arg[1]=="-q"
   RELATIVE = RELATIVE or arg[1]=="-r" or arg[1]=="-a" and nil
   if arg[1]=="-f" then 
      table.remove(arg,1)
      INFILE = assert(io.open(arg[1]))
   end
   if arg[1]=="-d" then 
      table.remove(arg,1)
      DELIMITER = ( arg[1]=="\\t" and "\t" or arg[1])
   end
   if arg[1]=="-h" then 
      for k,v in ipairs (help) do print(v) end; return      
   end
   if arg[1]=="-v" then 
      print ("version "..VERSION); return     
   end
   table.remove(arg,1)
end


function process_infile(filehandle)
   for line in io.input(filehandle):lines() do 
      if line:find("^#Q") then print(); os.exit() end
      process_input (line)
   end
return not nil
end

function process_include(f)
   if DEBUG then warn("INCLUDE\t",f,"\n") end
   for line in io.input(filehandle):lines() do 
      if line:find("^#Q") then break end
      process_input (line)
   end
return not nil
end


function process_stdin()
   while true do
      if PROMPT then io.write(PROMPT) end 
      local line = io.read()
      if line==NIL or line:find("^#Q") then break end
      process_input (line)
   end
   print()
return not nil
end


if TABLE then
   process_table(CONNECTORS, DELIMITER, INFILE)
else
   if PROMPT then io.write(SCRIPT.." version "..VERSION) end
   if DEBUG  then warn("   DEBUG MODE\n") end
   if PROMPT then print() end
   if MASK   then print("\27[H\27[J") end
   if INFILE then 
      local temp = io.input()
      process_infile(INFILE) 
      io.close(INFILE)
      io.input(temp)
   end
   if MASK then 
      loop() 
   else  
      process_stdin()
   end
end



--[[
process_line ("F = ( (9 / 5 ) * C ) + 32")
process_line ("K = C + 273.15")
process_line ("R = 80 * (C / 100)")


process_line ("C=25")
process_line ("F=212")
process_line ("C")
process_line ("F=212")
process_line ("F")
process_line ("K=0")
process_line ("K")
process_line ("R=80")
process_line ("R")
process_line ("R=0")
process_line ("R")
process_line ("C=100") 
dump_connectors()
--]]


   
   
